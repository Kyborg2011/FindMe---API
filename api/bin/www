#!/usr/bin/env node
var config = require( '../app/helpers/nconf.js' ),
  http = require( 'http' ),
  express = require( 'express' ),
  methodOverride = require( 'method-override' ),
  morgan = require( 'morgan' ),
  errorHandler = require( 'express-error-handler' ),
  bodyParser = require( 'body-parser' ),
  helmet = require( 'helmet' ),
  mongoose = require( 'mongoose' ),
  bluebird = require( 'bluebird' ),
  mongooseAutoIncrement = require( 'mongoose-auto-increment' ),
  passport = require( 'passport' );

// Init Express.js
var app = express();

// Configure Mongoose ODM
mongoose.Promise = bluebird;
mongoose.connect( config.get( 'env:mongoose:uri' ) );
mongooseAutoIncrement.initialize( mongoose.connection );

// Mongoose connection events
mongoose.connection.on( 'error', function ( err ) {
  console.error( 'Connection to database error: ' + err );
});

// Express.js app configure
app.use( morgan( 'dev' ) ); // Log every request to the console
app.use( methodOverride() ); // Checks request.body for HTTP method overrides
app.use( helmet.noCache() );
app.use( helmet.frameguard() );
app.use( bodyParser.json() ); // Parses request body and populates request.body
app.use( bodyParser.urlencoded({ extended: true }) );
app.use( passport.initialize() ); // Passport.js initialization
app.use( errorHandler() );

// Configure Passport.js oAuth2 strategies
require( '../app/helpers/passport' )( passport );

// Configure API routes
require( '../app/routes/routes.js' )( app, passport );

http.createServer( app ).listen( config.get( 'env:port' ) );
console.log( 'RESTful API is started on port ' + config.get( 'env:port' ) );
